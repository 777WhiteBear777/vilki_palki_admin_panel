<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin-panel/fragments/index}">

<head>
    <title>Users</title>
</head>

<th:block layout:fragment="content">

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header vilki-mod">
                    <h3 class="card-title text-light">Users Table | Общее кол-во:
                        <th:block th:text="${usersCount}"></th:block>
                    </h3>
                    <div class="card-tools">
                        <div class="input-group input-group-sm" style="width: 250px;">
                            <input type="text" oninput="filterNameInput(this)" id="users-table-search"
                                   class="form-control float-right"
                                   placeholder="Search">

                            <div class="input-group-append">
                                <button type="submit" class="btn btn-default">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- /.card-header -->
                <div class="card-body">
                    <table class="table table-bordered" id="users-table">
                        <thead>
                        <tr>
                            <th style="width: 10px">#</th>
                            <th>Email</th>
                            <th>Полное имя</th>
                            <th>Дата рождения</th>
                            <th>Facebook Id</th>
                            <th>Телефон</th>
                            <th>Сумма заказов</th>
                            <th style="width: 190px">Действия</th>
                        </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
                <!-- /.card-body -->
                <div class="card-footer clearfix vilki-mod">
                    <div class="row">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header vilki-mod">
                    <h3 class="card-title text-light">Admins Table | Общее кол-во:
                        <th:block th:text="${adminsCount}"></th:block>
                    </h3>
                    <div class="card-tools">
                        <div class="input-group input-group-sm" style="width: 250px;">
                            <input type="text" oninput="filterNameInput(this)" id="admins-table-search"
                                   class="form-control float-right"
                                   placeholder="Search">
                            <div class="input-group-append">
                                <button type="submit" class="btn btn-default">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- /.card-header -->
                <div class="card-body">
                    <table class="table table-bordered" id="admins-table">
                        <thead>
                        <tr>
                            <th style="width: 10px">#</th>
                            <th>Email</th>
                            <th>Имя</th>
                            <th>Фамилия</th>
                            <th>Security level</th>
                            <th style="width: 190px">Действия</th>
                        </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
                <!-- /.card-body -->
                <div class="card-footer clearfix vilki-mod">
                    <div class="row">
                    </div>
                </div>
            </div>
        </div>
    </div>

</th:block>

<!-- Extra Modals -->
<th:block layout:fragment="extra-modals">

    <div class="modal fade" id="confirm-user-delete">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-danger">
                <div class="modal-header">
                    <h4 class="modal-title">Delete Entity</h4>
                </div>
                <div class="modal-body">
                    <p>Вы уверены, что хотите удалить?</p>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-outline-dark" data-dismiss="modal">Нет</button>
                    <a id="delete-user-button" type="button" class="btn btn-outline-dark">Да</a>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirm-admin-delete">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-danger">
                <div class="modal-header">
                    <h4 class="modal-title">Delete Entity</h4>
                </div>
                <div class="modal-body">
                    <p>Вы уверены, что хотите удалить?</p>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-outline-dark" data-dismiss="modal">Нет</button>
                    <a id="delete-admin-button" type="button" class="btn btn-outline-dark">Да</a>
                </div>
            </div>
        </div>
    </div>

</th:block>

<th:block layout:fragment="extra-js">

    <script>

        const defaultItemCount = 5;
        let userRequest = {};
        userRequest.pageIndex = 0;
        let adminRequest = {};
        adminRequest.pageIndex = 0;
        let filterTimeout;

        $(document).ready(function () {
            getAllUsers();
            getAllAdmins();
        });

        $('#confirm-user-delete').on('show.bs.modal', function (e) {
            let id = $(e.relatedTarget).data('id');
            $('#delete-user-button').attr('href', '/users/delete-user/' + id);
        });
        $('#confirm-admin-delete').on('show.bs.modal', function (e) {
            let id = $(e.relatedTarget).data('id');
            $('#delete-admin-button').attr('href', '/users/delete-admin/' + id);
        });

        //  Get All Users
        function getAllUsers() {
            $.ajax({
                method: "POST",
                url: "/users/get-all-users",
                dataType: 'json',
                contentType: 'application/json',
                data: JSON.stringify(userRequest),
                beforeSend: function () {
                    console.log(userRequest)
                }
            }).done(function (usersResponse) {
                console.info(usersResponse);
                const TABLE_BODY = createTable('#users-table', usersResponse?.totalElements, usersResponse?.totalPages, userRequest?.pageIndex);
                $.each(usersResponse?.content, function (index, user) {
                    const $view = '' +
                        '<a href="/users/user-details/' + user?.id + '" class="btn pb-0 pt-0 btn-secondary">Детали</a>';
                    const $delete = '' +
                        '<a class="btn pb-0 pt-0 btn-danger" ' +
                        'data-id="' + user?.id + '" data-toggle="modal" data-target="#confirm-user-delete">Удалить</a>';
                    $(TABLE_BODY).append(
                        '<tr>' +
                        '    <td>' + ((index + 1) + (userRequest.pageIndex * usersResponse?.size)) + '</td>' +
                        '    <td>' + (user?.email ? user?.email : '-') + '</td>' +
                        '    <td>' + (user?.name ? user?.name : '-') + '</td>' +
                        '    <td>' + (user?.birthday ? user?.birthday : '—') + '</td>' +
                        '    <td>' + (user?.facebookId ? user?.facebookId : '—') + '</td>' +
                        '    <td>' + (user?.phoneNumber ? user?.phoneNumber : '—') + '</td>' +
                        '    <td>' + (user?.sumOrders ? user?.sumOrders : '—') + '</td>' +
                        '    <td>' + $view + $delete + '</td>' +
                        '</tr>'
                    );
                });
            });
        }

        function getAllAdmins() {
            $.ajax({
                method: "POST",
                url: "/users/get-all-admins",
                dataType: 'json',
                contentType: 'application/json',
                data: JSON.stringify(adminRequest),
                beforeSend: function () {
                    console.log(adminRequest)
                }
            }).done(function (adminsResponse) {
                console.info(adminsResponse);
                const TABLE_BODY = createTable('#admins-table', adminsResponse?.itemsCount, adminsResponse?.pagesCount, adminRequest?.pageIndex);
                $.each(adminsResponse?.data, function (index, admin) {
                    const $delete = '' +
                        '<a class="btn pb-0 pt-0 btn-danger" ' +
                        'data-id="' + admin?.id + '" data-toggle="modal" data-target="#confirm-admin-delete">Удалить</a>';
                    $(TABLE_BODY).append(
                        '<tr>' +
                        '    <td>' + ((index + 1) + (adminRequest.pageIndex * defaultItemCount)) + '</td>' +
                        '    <td>' + (admin?.email ? admin?.email : '-') + '</td>' +
                        '    <td>' + (admin?.firstname ? admin?.firstname : '-') + '</td>' +
                        '    <td>' + (admin?.lastname ? admin?.lastname : '-') + '</td>' +
                        '    <td>' + (admin?.securityLevel ? admin?.securityLevel : '-') + '</td>' +
                        '    <td>' + $delete + '</td>' +
                        '</tr>'
                    );
                });
            });
        }

        //  Page click action
        $(document).on('click', 'a.page-link', function () {
            const pageBtn = $(this);
            const whichTable = $(pageBtn).parents('div.card').find('table').attr('id');
            if (whichTable === 'users-table') {
                if ($(pageBtn).parent('li.page-item').hasClass('prev')) {
                    userRequest.pageIndex = --userRequest.pageIndex;
                } else if ($(pageBtn).parent('li.page-item').hasClass('next')) {
                    userRequest.pageIndex = ++userRequest.pageIndex;
                } else {
                    userRequest.pageIndex = Number($(pageBtn).text()) - 1;
                }
                getAllUsers();
            } else {
                if ($(pageBtn).parent('li.page-item').hasClass('prev')) {
                    adminRequest.pageIndex = --adminRequest.pageIndex;
                } else if ($(pageBtn).parent('li.page-item').hasClass('next')) {
                    adminRequest.pageIndex = ++adminRequest.pageIndex;
                } else {
                    adminRequest.pageIndex = Number($(pageBtn).text()) - 1;
                }
                getAllAdmins();
            }

        });

        function filterNameInput(input) {
            clearInterval(filterTimeout)
            filterTimeout = setTimeout(() => {
                if ($(input).attr('id') === 'users-table-search') {
                    userRequest.query = $(input).val();
                    userRequest.pageIndex = 0;
                    getAllUsers();
                } else if ($(input).attr('id') === 'admins-table-search') {
                    adminRequest.query = $(input).val();
                    adminRequest.pageIndex = 0;
                    getAllAdmins();
                }
            }, 1000)
        }

    </script>

</th:block>

</html>
